/*
 * Copyright (c) Simverge Software LLC - All Rights Reserved
 */

#include <stdlib.h>
#include <stdio.h>
#include <assert.h>

#include "greatest.h"

#include <pdal/capi/Pipeline.h>
#include <pdal/capi/PointView.h>
#include <pdal/capi/PointViewIterator.h>

/// A simple binary tree implementation for int values
struct node
{
	int key;
	struct node *left;
	struct node *right;
};

void dispose(struct node *n)
{
	if (n == NULL)
	{
		dispose(n->left);
		dispose(n->right);
		free(n);
	}
}

bool insert(int key, struct node **n)
{
	bool inserted = false;

	if (*n == NULL)
	{
		*n = (struct node *) malloc(sizeof(struct node));
		(*n)->key = key;
		(*n)->left = NULL;
		(*n)->right = NULL;
		inserted = true;
	}
	else if (key < (*n)->key)
	{
		inserted = insert(key, &(*n)->left);
	}
	else if (key > (*n)->key)
	{
		inserted = insert(key, &(*n)->right);
	}

	return inserted;
}

SUITE(PointViewTest);

static const int INVALID_POINT_VIEW_ID = 0;
static PDALPipelinePtr gPipeline = NULL;
static PDALPointViewIteratorPtr gPointViewIterator = NULL;

static void setupPointViewTest(void *arg)
{
	FILE *file = fopen("@CMAKE_BINARY_DIR@/data/simple-reproject.json", "rb");
	char *json = NULL;

	if (file)
	{
		fseek(file, 0, SEEK_END);
		long length = ftell(file);
		fseek(file, 0, SEEK_SET);
		char *json = malloc(length + 1);

		if (json)
		{
			fread(json, 1, length, file);
			json[length] = '\0';
			gPipeline = PDALCreatePipeline(json);

			if (gPipeline && PDALExecutePipeline(gPipeline))
			{
				gPointViewIterator = PDALGetPointViews(gPipeline);
			}

			free(json);
		}

		fclose(file);
	}
}

static void teardownPointViewTest(void *arg)
{
	PDALDisposePointViewIterator(gPointViewIterator);
	PDALDisposePipeline(gPipeline);
}

TEST testPDALGetPointViewId(void)
{
	ASSERT_EQ(INVALID_POINT_VIEW_ID, PDALGetPointViewId(NULL));

	PDALResetPointViewIterator(gPointViewIterator);
	bool hasNext = PDALHasNextPointView(gPointViewIterator);
	ASSERT(hasNext);

	struct node *tree = NULL;

	while (hasNext)
	{
		PDALPointViewPtr view = PDALGetNextPointView(gPointViewIterator);
		ASSERT(view);

		// Make sure all IDs are valid
		int id = PDALGetPointViewId(view);
		ASSERT_FALSE(id == INVALID_POINT_VIEW_ID);

		// Make sure that there are no duplicate IDs
		bool inserted = insert(id, &tree);
		ASSERT(inserted);

		hasNext = PDALHasNextPointView(gPointViewIterator);
	}

	dispose(tree);

	PASS();
}

TEST testPDALGetPointViewSize(void)
{
	ASSERT_EQ(0, PDALGetPointViewSize(NULL));

	PASS();
}

TEST testPDALIsPointViewEmpty(void)
{
	ASSERT(PDALIsPointViewEmpty(NULL));

	PASS();
}

TEST testPDALClonePointView(void)
{
	PDALResetPointViewIterator(gPointViewIterator);


	PASS();
}

TEST testPDALGetPointViewProj4(void)
{
	PDALResetPointViewIterator(gPointViewIterator);
	bool hasNext = PDALHasNextPointView(gPointViewIterator);
	ASSERT(hasNext);

	PDALPointViewPtr view = PDALGetNextPointView(gPointViewIterator);
	ASSERT(view);

	char proj[1024];
	size_t size = PDALGetPointViewProj4(NULL, proj, 1024);
	ASSERT_EQ(0, size);
	ASSERT_EQ('\0', proj[0]);

	size = PDALGetPointViewProj4(view, NULL, 1024);
	ASSERT_EQ(0, size);

	size = PDALGetPointViewProj4(view, proj, 0);
	ASSERT_EQ(0, size);

	size = PDALGetPointViewProj4(view, proj, 1024);
	ASSERT(size > 0 && size <= 1024);
	ASSERT_FALSE(proj[0] == '\0');
	ASSERT_STR_EQ("+proj=longlat +datum=WGS84 +no_defs", proj);

	PASS();
}

TEST testPDALGetPointViewWkt(void)
{
	PDALResetPointViewIterator(gPointViewIterator);
	bool hasNext = PDALHasNextPointView(gPointViewIterator);
	ASSERT(hasNext);

	PDALPointViewPtr view = PDALGetNextPointView(gPointViewIterator);
	ASSERT(view);

	char wkt[1024];
	size_t size = PDALGetPointViewWkt(NULL, wkt, 1024, false);
	ASSERT_EQ(0, size);
	ASSERT_EQ('\0', wkt[0]);

	size = PDALGetPointViewWkt(view, NULL, 1024, false);
	ASSERT_EQ(0, size);

	size = PDALGetPointViewWkt(view, wkt, 0, false);
	ASSERT_EQ(0, size);

	size = PDALGetPointViewWkt(view, wkt, 1024, false);
	ASSERT(size > 0 && size <= 1024);
	ASSERT_FALSE(wkt[0] == '\0');
	ASSERT_STR_EQ(
		"GEOGCS[\"WGS 84\","
			"DATUM[\"WGS_1984\","
				"SPHEROID[\"WGS 84\",6378137,298.257223563,AUTHORITY[\"EPSG\",\"7030\"]],"
				"AUTHORITY[\"EPSG\",\"6326\"]"
			"],"
			"PRIMEM[\"Greenwich\",0,AUTHORITY[\"EPSG\",\"8901\"]],"
			"UNIT[\"degree\",0.0174532925199433,AUTHORITY[\"EPSG\",\"9122\"]],"
			"AUTHORITY[\"EPSG\",\"4326\"]"
		"]",
		wkt
	);

	PASS();
}


TEST testPDALGetPointViewLayout(void)
{
	PDALPointLayoutPtr layout = PDALGetPointViewLayout(NULL);
	ASSERT_EQ(NULL, layout);

	PDALResetPointViewIterator(gPointViewIterator);
	bool hasNext = PDALHasNextPointView(gPointViewIterator);
	ASSERT(hasNext);

	PDALPointViewPtr view = PDALGetNextPointView(gPointViewIterator);
	ASSERT(view);

	layout = PDALGetPointViewLayout(view);
	ASSERT(layout);

	PASS();
}

GREATEST_SUITE(PointViewTest)
{
	SET_SETUP(setupPointViewTest, NULL);
	SET_TEARDOWN(teardownPointViewTest, NULL);

	RUN_TEST(testPDALGetPointViewId);
	RUN_TEST(testPDALGetPointViewSize);
	RUN_TEST(testPDALIsPointViewEmpty);
	RUN_TEST(testPDALClonePointView);
	RUN_TEST(testPDALGetPointViewProj4);
	RUN_TEST(testPDALGetPointViewWkt);
	RUN_TEST(testPDALGetPointViewLayout);

	SET_SETUP(NULL, NULL);
	SET_TEARDOWN(NULL, NULL);
}
/*
 * Copyright (c) Simverge Software LLC - All Rights Reserved
 */

#include <stdlib.h>
#include <stdio.h>
#include <assert.h>

#include "greatest.h"

#include <pdal/capi/Pipeline.h>
#include <pdal/capi/PointLayout.h>
#include <pdal/capi/PointView.h>
#include <pdal/capi/PointViewIterator.h>

SUITE(PointLayoutTest);

static PDALPipelinePtr gPipeline = NULL;
static PDALPointViewPtr gPointView = NULL;
static PDALPointLayoutPtr gLayout = NULL;

static void setupPointLayoutTest(void *arg)
{
	FILE *file = fopen("@CMAKE_BINARY_DIR@/data/simple-reproject.json", "rb");
	char *json = NULL;

	if (file)
	{
		fseek(file, 0, SEEK_END);
		long length = ftell(file);
		fseek(file, 0, SEEK_SET);
		char *json = malloc(length + 1);

		if (json)
		{
			fread(json, 1, length, file);
			json[length] = '\0';
			gPipeline = PDALCreatePipeline(json);

			if (gPipeline && PDALExecutePipeline(gPipeline))
			{
				PDALPointViewIteratorPtr views = PDALGetPointViews(gPipeline);

				if (PDALHasNextPointView(views))
				{
					gPointView = PDALGetNextPointView(views);

					if (gPointView)
					{
						gLayout = PDALGetPointViewLayout(gPointView);
					}
				}
			}

			free(json);
		}

		fclose(file);
	}
}

static void teardownPointLayoutTest(void *arg)
{
	PDALDisposePointView(gPointView);
	PDALDisposePipeline(gPipeline);
}

TEST testPDALGetPointLayoutDimTypes(void)
{
	ASSERT(gLayout);
	PDALDimTypeListPtr types = PDALGetPointLayoutDimTypes(NULL);
	ASSERT_EQ(NULL, types);

	types = PDALGetPointLayoutDimTypes(gLayout);
	ASSERT(types);

	size_t size = PDALGetDimTypeListSize(types);
	ASSERT(size > 0);

	PDALDisposeDimTypeList(types);
	size = PDALGetDimTypeListSize(types);
	ASSERT_EQ(0, size);

	PASS();
}

TEST testPDALGetDimSize(void)
{
	ASSERT(gLayout);
	size_t size = PDALGetDimSize(NULL, NULL);
	ASSERT_EQ(0, size);

	int numTypes = 3;
	const char *types[] = {"X", "Y", "Z"};

	for (int i = 0; i < numTypes; ++i)
	{
		size = PDALGetDimSize(NULL, types[i]);
		ASSERT_EQ(0, size);

		size = PDALGetDimSize(gLayout, types[i]);
		ASSERT(size > 0);
	}

	PASS();
}

TEST testPDALGetDimPackedOffset(void)
{
	ASSERT(gLayout);
	size_t offset = PDALGetDimPackedOffset(NULL, NULL);
	ASSERT_EQ(0, offset);

	int numTypes = 3;
	const char *types[] = {"X", "Y", "Z"};

	for (int i = 0; i < numTypes; ++i)
	{
		offset = PDALGetDimPackedOffset(NULL, types[i]);
		ASSERT_EQ(0, offset);

		offset = PDALGetDimPackedOffset(gLayout, types[i]);
	
		if (strcmp(types[i], "X") == 0)
		{
			ASSERT_EQ(0, offset);
		}
		else
		{
			ASSERT(offset > 0);
		}
	}

	PASS();
}

TEST testPDALGetPointSize(void)
{
	ASSERT(gLayout);
	size_t size = PDALGetPointSize(NULL);
	ASSERT_EQ(0, size);

	size = PDALGetPointSize(gLayout);
	ASSERT(size > 0);
	PASS();
}

GREATEST_SUITE(PointLayoutTest)
{
	SET_SETUP(setupPointLayoutTest, NULL);
	SET_TEARDOWN(teardownPointLayoutTest, NULL);

	RUN_TEST(testPDALGetPointLayoutDimTypes);
	RUN_TEST(testPDALGetDimSize);
	RUN_TEST(testPDALGetDimPackedOffset);
	RUN_TEST(testPDALGetPointSize);

	SET_SETUP(NULL, NULL);
	SET_TEARDOWN(NULL, NULL);
}